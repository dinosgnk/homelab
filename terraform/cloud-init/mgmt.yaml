#cloud-config
hostname: ${hostname}
fqdn: ${hostname}.${domain}
manage_etc_hosts: true

package_update: true
package_upgrade: true

users:
  - name: labadmin
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: 
      - sudo
      - docker
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_key}

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - git
  - qemu-guest-agent

runcmd:
  # Enable and start QEMU guest agent
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Add labadmin user to docker group
  - usermod -aG docker labadmin
  
  # Install Docker Compose standalone (v2)
  - curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Generate SSH key for remote access
  - su - labadmin -c 'ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -C "mgmt-server"'
